<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>Dspam Python Module</title>
</head><body>

<P ALIGN="CENTER"><A HREF="http://www.anybrowser.org/campaign/">
<IMG SRC="/art/brain1.gif"
ALT="Viewable With Any Browser" BORDER="0"></A>
<img src="/art/sepschool2.gif" width="468" height="60" usemap="#SepSchool"
  border="0" alt="Should we end government education?">
 <map name="SepSchool">
   <area shape="rect" coords="351,30,400,57" href="http://www.sepschool.org/Proc/" alt="Vote YES">
   <area shape="rect" coords="406,29,455,56" href="http://209.24.29.72/NEP/" alt="Vote NO">
  </map> 
</P>
<h1 align=center>Bayesian Message Filtering for Python</h1>
<h4 align=center>
  by <a href="mailto:%73%74%75%61%72%74%40%62%6D%73%69%2E%63%6F%6D">
  Stuart D. Gathman</a><br>
This web page is written by Stuart D. Gathman<br>and<br>sponsored by
<a href="http://www.bmsi.com">Business Management Systems, Inc.</a> <br>
Last updated Jul 30, 2003</h4>

<b>Update:</b> pydspam-1.0 available separately.<br>
<a href="#download">Downloads</a>,<a href="#bugs">Bugs</a>,
<a href="#triage">Header Triage</a>

<p>
This project adds Python support, bug fixes, and additional utilities
to the excellent 
<a href="http://www.networkdweebs.com/software/dspam/">DSPAM</a> project
provided by
<a href="mailto:j%6F%6E%61%74h%61%6E%40%6E%65%74work%64w%65%65%62%73%2E%63%6F%6D">Jonathan A. Zdziarski</a>.  
Neither BMS or Stuart Gathman are affiliated with Jonathan Zdziarski 
or <a href="http://networkdweebs.com/">Network Dweebs</a>, except as
enthusiastic users of their free product.
<p>
What is DSPAM?  Here is an excerpt from
the DSPAM project README:

<blockquote>
<a href="http://www.networkdweebs.com/software/dspam/">DSPAM</a> is an
open-source, freely available anti-spam solution designed to combat
unsolicited commercial email using Baye's theorem of combined probabilities.
The result is an administratively maintenance free system capable of learning 
each user's email behaviors with very few false positives.
<p>
DSPAM can be implemented in one of two ways:
<ol>
<li> The DSPAM mailer-agent provides server-side spam filtering, quarantine
box, and a mechanism for forwarding spams into the system to be automatically
analyzed.
<li>Developers may link their projects to the dspam core engine (libdspam) in
accordance with the GPL license agreement.  This enables developers to
incorporate libdspam as a "drop-in" for instant spam filtering within their
applications - such as mail clients, other anti-spam tools, and so on.
</ol>
Many of the ideas incorporated into this agent were contributed by Paul
Graham's excellent 
<a href="http://paulgraham.com/spam.html">
white paper on combatting SPAM</a>.
Many new approaches have also been implemented by DSPAM.
</blockquote>
<p>

<h2> Dspam RPMs </h2>

The RPMs include patches for many bug fixes to the original dspam code,
and both C and Python unit tests to make sure they stay fixed.  Python includes
a built-in unit testing framework.  The C tests use the 
<a href="http://check.sourceforge.net">check project</a>.  The RPM build
procedure does not attempt to build or run the unit tests, so the check
framework is not needed to build the RPM.
<p>
Cron entries for dspam_purge and dspam_clean are provided as is 
a 'dspam' local mailer macro for sendmail-cf.  To activate dspam with these
RPMs for the version of sendmail included with RedHat, simply replace
<code>MAILER(local)</code>
with <code>MAILER(dspam)</code> in <code>/etc/mail/sendmail.mc</code>, then
regenerate <code>sendmail.cf</code> (instructions are in the comments at the
top of <code>sendmail.mc</code>).
<p>
<img src="python55.gif" align=left alt="A Python">
The RPMs also include a dspam-python sub-package which is built from the
pydspam-1.0 source.  The dspam-python binary RPM
provides a <a href="//www.python.org">Python</a> module which wraps the dspam
core engine (libdspam).  Many of the dspam command line tools are reimplemented
in Python to illustrate use of the library.  (Installed as documentation by the
RPM.)  The RPMs also include patches to add a new libdspam entry point:
_ds_tokenize(), and a new tool, pydspam_anal.py, is implemented in Python to
illustrate its use.

<h2> <a name=triage>Header Triage with Dspam and Python Milter</a> </h2>

For a really powerful mail filtering system, combine the DSPAM Python
module with <a href="http://www.sendmail.org">sendmail</a> and
<a href="milter.html">Python Milter</a>.  For instance, here is
a simple change to milter-0.5.5 I am testing:
<a href="milter-bms.patch">Patch to bms.py from milter-0.5.5</a>.
<p>
The dictionary is the one maintained by the dspam delivery agent installed
with the dspam package.  Scanning the headers in the milter allows us
to REJECT spam connections before they've wasted all our bandwidth.
<p>
To show just how bad the spam problem is, here are statistics for our
domain with just 6 users.  Two users (including me) are published on 
the web with HTML encoding.  I also use my real email when posting
to newsgroups.  Because my email is acessible, I receive welcome email
from fellow techies all over the world.  
<p>
<table>
<tr> <th colspan=2> Statistics for Jul 15 </th>
<tr> <td> 1139 </td> <td> Messages from known spamming domains refused by
	sendmail. </td>
<tr> <td> 160 </td> <td> Messages REJECTED by milter because of banned
	keywords like 'viagra'. </td>
<tr> <td> 169 </td> <td> Messages REJECTED by milter because of high
	Dspam scores for headers. </td>
<tr> <td> 261 </td> <td> Messages quarrantined by Dspam
	mail delivery agent. </td>
<tr> <td> 40 </td> <td> Actual email received for 6 users.</td>
</table>
<p>
We do not use a black hole list for known spamming IPs / domains.  This
is because some of our customers use blacklisted ISPs because they
are the only broadband available in their area.  Black hole lists like
to blacklist entire ISPs, including innocent customers who have no
other choice (other than dialup) for connectivity.
With a little python programming to collect data, DSPAM will allow us to
automate building the list of banned IPs / domains.
<p>
The header triage feature will be in milter-0.5.6.  I envision a complete
milter based implementation of dspam which appoints selected 
email destinations as 'moderators'.  The MDA approach currently used
by dspam requires all users to diligently classify their email to train
the filter.  In the new approach, moderators will do this work, and
the resulting dspam dictionary used to filter mail for other users
in their group.

<h2> <a name=bugs>Bugs</a> </h2>

<h3> Learning Decay </h3>

Here I address a problem encountered with the Dspam approach.
There needs to be some sort of decay of learned messages.  Otherwise,
adaptation gets less and less with each message until we're effectively not
learning any more.  One approach would be to periodically divide all hit counts
by 2.  For instance, when total messages (Spam + Innocent) reaches 4000 (or
some other number substantially bigger than 1000), then divide all hits and
totals in the dictionary by 2.  This will give the next 2000 messages double
the weight of the previous 4000.  And messages 6001-8000 will have four times
the weight of 1-4000, and twice the weight of 4001-6000.
<p>
Dspam_purge would be a good place to implement the decay algorithm.
We might then want to add a new totals record, e.g. '_GTOT'.  This
would keep the real (not scaled) totals that humans are interested in.

<h3> Database Scrubbing </h3>

  I have had dspam_purge in an infinite loop because of loops (corruption)
  in the dictionary.  I created a python version of dspam_purge that checks for
  encountering the same record again.  This effectively cleaned the
  dictionary.
<p>
  The dspam_clean utility should work like dspam_purge - copy records to
  be retained to a new database, then delete and rename.  This will
  clean any glitches from bugs in libdb, or abnormal terminations of
  the dspam MDA.  Also, both purge and clean need to check for encountering
  the same record again while reading the old database.  This is easily 
  done by checking for dups while writing the new database.
<p>
  I have had the dspam MDA in an infinite loop while trying to delete
  a signature because the sig database was corrupted - probably because
  of the empty body crasher bug in libdspam (now fixed in my version).  Again,
  a quick python script to copy the records to a new DB did the trick.  I will
  create a full python replacement for dspam_clean after my vacation.

<h3>Extended Signature State</h3>

  A user can get confused when changing their mind about whether a
  message is spam.  It is hard to remember whether you've already
  done an ADDSPAM or FALSEPOSITIVE and which one you did last.
  In my python milter based on libdspam, I plan to add a flag to the
  signature database to record the last
  action for a signature.  The states will be NEW,SPAM,INNOCENT
  The dspam MDA would always set the state to SPAM or INNOCENT.  Then
  dspam --addspam would do nothing if the message was already in
  the spam state, and --falsepositive would do nothing if the message
  was already in the INNOCENT state.
  It would be nice for the user to query the current state given
  a signature id.
<p>
  I am considering having a NEW state for signatures that have not
  yet been added to the statistics either way.  This would be useful
  for users that are not diligent in classifying all email.

<h3> Mozilla/Netscape Bundles Forwards </h3>

  It is natural for users to select all their spam, then forward it
  to the spam alias.  Unfortunately, Mozilla combines all the messages
  into a single message for forwarding.  The dspam MDA finds only the first
  signature tag in the combined message.
<p>
  My suggestion is that the Dspam MDA should look for multiple DSPAM tags in 
  the email.  Or perhaps, recursively scan rfc822 attachments.
<p>
  In the meantime, users should use pine, or forward each spam individually
  to the spam alias.

<h2> <a name="download">Downloads</a> </h2>

Pick one of the following.  The binary RPM is the easiest, and will run
on Red Hat 7.2 or 7.3 (and probably later versions).  The source RPM
contains all the required source and patches, and can be recompiled to match
your distribution.  And finally, you can grab the original sources and my
patches and do it yourself.
<p>
Release 3 splits python support into a sub package, adds unit test and
fix for CORPUS bug.
<p>
Release 2.6.2.02-1 tracks dspam-2.6.2.02 from Network Dweebs.  The python
support is moved to a separate source tarball (pydspam-1.0).  Network Dweebs
does not want it added to the Dspam source tree.  The binary package
is still called dspam-python (and is not required to use only
the C Dspam programs).

<h3> Binary RPMs </h3>

  <h4> RedHat 7.2 </h4>
<menu>
<li><a href="/linux/rh72/dspam-2.6.2-3.i386.rpm">dspam-2.6.2-3</a>
  RedHat 7.2 binary RPM
<li><a href="/linux/rh72/dspam-devel-2.6.2-3.i386.rpm">dspam-devel-2.6.2-3.i386.rpm</a>
  Development headers and static library
<li><a href="/linux/rh72/dspam-python-2.6.2-3.i386.rpm">dspam-python-2.6.2-3.i386.rpm</a>
  Python module and utilities
<li><a href="/linux/rh72/dspam-2.6.2.02-1.i386.rpm">dspam-2.6.2.02-1</a>
  RedHat 7.2 binary RPM
<li><a href="/linux/rh72/dspam-devel-2.6.2.02-1.i386.rpm">dspam-devel-2.6.2.02-1.i386.rpm</a>
  Development headers and static library
<li><a href="/linux/rh72/dspam-python-2.6.2.02-1.i386.rpm">dspam-python-2.6.2.02-1.i386.rpm</a>
  Python module and utilities
</menu>

  <h4> RedHat 7.3 </h4>
<menu>
<li> <a href="/linux/rh73/dspam-2.6.2-3.i386.rpm">dspam-2.6.2-3</a>
  RedHat 7.3 binary RPM
<li><a href="/linux/rh73/dspam-devel-2.6.2-3.i386.rpm">dspam-devel-2.6.2-3.i386.rpm</a>
  Development headers and static library
<li><a href="/linux/rh73/dspam-python-2.6.2-3.i386.rpm">dspam-python-2.6.2-3.i386.rpm</a>
  Python module and utilities
</menu>

  <h4> AIX 4.x </h4>
<menu>
<li> <a href="/aix/dspam-2.6.2-3.ppc.rpm">dspam-2.6.2-3.ppc.rpm</a>
  AIX 4.x binary RPM
<li><a href="/aix/dspam-devel-2.6.2-3.ppc.rpm">dspam-devel-2.6.2-3.ppc.rpm</a>
  Development headers and static library
<li><a href="/aix/dspam-python-2.6.2-3.ppc.rpm">dspam-python-2.6.2-3.ppc.rpm</a>
  Python module and utilities
</menu>

<h3> Source and Source RPMs </h3>
<menu>
<li> <a href="/linux/rh73/dspam-2.6.2-3.src.rpm">dspam-2.6.2-3.src.rpm</a>
  Source RPM (tested on RedHat 7.x and AIX 4.1.5).
<li> <a href="/linux/rh73/dspam-2.6.2.02-1.src.rpm">dspam-2.6.2.02-1.src.rpm</a>
  Source RPM (tested on RedHat 7.2)
<li> <a href="dspam.patch"> Patches against the original dspam-2.6.2 source</a>
  Fixes bugs and adds python directory.  (Will move python directory
  to separate pydspam project shortly.)
<li> <a href="dspam-2.6.2.02.patch">
  Patches against the original dspam-2.6.2.02 source</a>
  Fixes bugs and adds unit tests and _ds_tokenize entry point.
<li> <a href="dspam-db3.patch"> Patches to configure to compile with db3 </a>
  This is in the Source RPM, but those downloading the raw source might
  need it also.
<li> <a href="/python/pydspam-1.0.tar.gz">pydspam-1.0.tar.gz</a>
  Python interface to libdspam and some dspam utilities in python.
<li> <a href="/linux/dspam-2.6.2.tar.gz">
	dspam-2.6.2 source (dspam site does not have archives)</a>
<li> <a href="/linux/dspam-2.6.2.02.tar.gz">
	dspam-2.6.2.02 source (dspam site does not have archives)</a>
</menu>

<h3> Check RPMs </h3>
<menu>
<li> <a href="/linux/rh72/check-0.8.4-1.i386.rpm">check-0.8.4 RedHat 7.x RPM</a>
<li> <a href="/aix/check-0.8.4-2.ppc.rpm">check-0.8.4 AIX 4.x RPM</a>
<li> <a href="/aix/check-0.8.4-2.src.rpm">check-0.8.4 source RPM</a>
</menu>

<hr>
<p>
<a href="http://validator.w3.org/check/referer">
<img border=0 src="/vh32.png" alt=" [ Valid HTML 3.2! ] " height=31 width=88></a>
<a href="http://www.redhat.com">
<img src="/art/powered_by.gif" width="88" height="31" alt=" [ Powered By Red Hat Linux ] " border="0"></a>
</p>
<a href="mailto:honeybear@editorialunilit.com">Send Spam</a>

</body></html>
