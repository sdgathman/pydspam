<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>Dspam Python Module</title>
</head><body>

<P ALIGN="CENTER"><A HREF="http://www.anybrowser.org/campaign/">
<IMG SRC="/art/brain1.gif"
ALT="Viewable With Any Browser" BORDER="0"></A>
<img src="/art/sepschool2.gif" width="468" height="60" usemap="#SepSchool"
  border="0" alt="Should we end government education?">
 <map name="SepSchool">
   <area shape="rect" coords="351,30,400,57" href="http://www.sepschool.org/Proc/" alt="Vote YES">
   <area shape="rect" coords="406,29,455,56" href="http://209.24.29.72/NEP/" alt="Vote NO">
  </map> 
</P>
<h1 align=center>Bayesian Message Filtering for Python</h1>
<h4 align=center>
  by <a href="mailto:%73%74%75%61%72%74%40%62%6D%73%69%2E%63%6F%6D">
  Stuart D. Gathman</a><br>
This web page is written by Stuart D. Gathman<br>and<br>sponsored by
<a href="http://www.bmsi.com">Business Management Systems, Inc.</a> <br>
Last updated Jul 14, 2003</h4>

This project adds Python support, bug fixes, and additional utilities
to the excellent 
<a href="http://www.networkdweebs.com/software/dspam/">DSPAM</a> project
provided by
<a href="mailto:j%6F%6E%61%74h%61%6E%40%6E%65%74work%64w%65%65%62%73%2E%63%6F%6D">Jonathan A. Zdziarski</a>.  
Neither BMS or Stuart Gathman are affiliated with Jonathan Zdziarski 
or <a href="http://networkdweebs.com/">Network Dweebs</a>, except as
enthusiastic users of their free product.
<p>
What is DSPAM?  Here is an excerpt from
the DSPAM project README:

<blockquote>
<a href="http://www.networkdweebs.com/software/dspam/">DSPAM</a> is an
open-source, freely available anti-spam solution designed to combat
unsolicited commercial email using Baye's theorem of combined probabilities.
The result is an administratively maintenance free system capable of learning 
each user's email behaviors with very few false positives.
<p>
DSPAM can be implemented in one of two ways:
<ol>
<li> The DSPAM mailer-agent provides server-side spam filtering, quarantine
box, and a mechanism for forwarding spams into the system to be automatically
analyzed.
<li>Developers may link their projects to the dspam core engine (libdspam) in
accordance with the GPL license agreement.  This enables developers to
incorporate libdspam as a "drop-in" for instant spam filtering within their
applications - such as mail clients, other anti-spam tools, and so on.
</ol>
Many of the ideas incorporated into this agent were contributed by Paul
Graham's excellent 
<a href="http://paulgraham.com/spam.html">
white paper on combatting SPAM</a>.
Many new approaches have also been implemented by DSPAM.
</blockquote>
<p>

<img src="python55.gif" align=left alt="A Python">
The RPMs for dspam-2.6.2 available from this web page include a <a
href="//www.python.org">Python</a> module which wraps the dspam core engine
(libdspam).  All of the dspam command line tools are reimplemented in 
Python to illustrate use of the library.  (The Python versions are not
installed by the RPM.)  The RPMs also include patches to add a new
libdspam entry point: _ds_tokenize(), and a new tool, dspam_anal.py, is
implemented in Python to illustrate its use.
<p>
The RPMs also include patches for many bug fixes to the original dspam code,
and both C and Python unit tests to make sure they stay fixed.  Python includes
a built-in unit testing framework.  The C tests use the 
<a href="http://check.sourceforge.net">check project</a>.  The RPM build
procedure does not attempt to build or run the unit tests, so the check
framework is not needed to build the RPM.

<h2> Dspam and Python Milter </h2>

For a really powerful mail filtering system, combine the DSPAM Python
module with <a href="http://www.sendmail.org">sendmail</a> and
<a href="milter.html">Python Milter</a>.  For instance, here is
a simple change to milter-0.5.5 I am testing:
<pre>
*** bms.py	Mon Jul 14 16:26:31 2003
--- dspambms.py	Mon Jul 14 16:24:34 2003
***************
*** 91,96 ****
--- 91,97 ----
  import StringIO
  import rfc822
  import mime
+ import dspam
  import Milter
  import tempfile
  import ConfigParser
***************
*** 120,125 ****
--- 121,127 ----
  internal_connect = ()
  internal_domains = ()
  smart_alias = {}
+ dspam_dict = '/var/log/milter/dspam/bms.dict'
  
  class MilterConfigParser(ConfigParser.ConfigParser):
  
***************
*** 230,235 ****
--- 232,243 ----
      if not rcpt in self.redirect_list:
        self.redirect_list.append(rcpt)
  
+   # addheader can only be called from eom().  This accumulates added headers
+   # which can then be applied by alter_headers()
+   def add_header(self,name,val):
+     self.new_headers.append((name,val))
+     self.log('%s: %s' % (name,val))
+ 
    def connect(self,hostname,unused,hostaddr):
      self.internal_connection = 0
      if hostaddr and len(hostaddr) > 0:
***************
*** 263,268 ****
--- 271,277 ----
      self.discard = 0
      self.redirect_list = []
      self.discard_list = []
+     self.new_headers = []
      t = parse_addr(f)
      if len(t) == 2:
        domain = t[1]
***************
*** 387,392 ****
--- 396,414 ----
      self.tempname = fname = tempfile.mktemp(".defang")
      self.fp = open(fname,"w+b")
      self.fp.write(headers)	# IOError (e.g. disk full) causes TEMPFAIL
+     # check if headers are really spammy
+     if not self.internal_connection:
+       ds = dspam.dspam(dspam_dict,dspam.DSM_PROCESS,
+         dspam.DSF_CHAINED|dspam.DSF_CLASSIFY)
+       try:
+         ds.process(headers)
+         if ds.probability > 0.93:
+           self.log('REJECT: X-DSpam-HeaderScore: %f' % ds.probability)
+ 	  self.setreply('554','5.7.1','Your Message looks spammy')
+ 	  return Milter.REJECT
+ 	self.add_header('X-DSpam-HeaderScore','%f'%ds.probability)
+       finally:
+         ds.destroy()
      return Milter.CONTINUE
  
    def body(self,chunk):		# copy body to temp file
***************
*** 436,441 ****
--- 458,465 ----
      if self.hidepath: del msg['Received']
  
      self.alter_recipients(self.discard_list,self.redirect_list)
+     for name,val in self.new_headers:
+       self.addheader(name,val)
  
      # filter leaf attachments through _chk_attach
      try:
</pre>

The dictionary is the one maintained by the dspam delivery agent installed
with the dspam package.  Scanning the headers in the milter allows us
to REJECT spam connections before they've wasted all our bandwidth.
I plan on implementing a complete milter based dspam solution in milter-0.5.6.

<h2> Downloads </h2>

Pick one of the following.  The binary RPM is the easiest, and will run
on Red Hat 7.2 or 7.3 (and probably later versions).  The source RPM
can be recompiled to match your distribution.  And finally, you can
grab the original sources and my patches and do it yourself.
<p>
Release 3 splits python support into a sub package, adds unit test and
fix for CORPUS bug.
<menu>
<li><a href="/linux/rh72/dspam-2.6.2-3.i386.rpm">dspam-2.6.2-3</a>RedHat 7.2 binary RPM
<li><a href="/linux/rh72/dspam-devel-2.6.2-3.i386.rpm">dspam-devel-2.6.2-3.i386.rpm</a>
  Development headers and static library
<li><a href="/linux/rh72/dspam-python-2.6.2-3.i386.rpm">dspam-python-2.6.2-3.i386.rpm</a>
  Python module and utilities
<li> <a href="/linux/rh73/dspam-2.6.2-3.i386.rpm">dspam-2.6.2-3</a>RedHat 7.3 binary RPM
<li><a href="/linux/rh73/dspam-devel-2.6.2-3.i386.rpm">dspam-devel-2.6.2-3.i386.rpm</a>
  Development headers and static library
<li><a href="/linux/rh73/dspam-python-2.6.2-3.i386.rpm">dspam-python-2.6.2-3.i386.rpm</a>
  Python module and utilities
<li> <a href="/aix/dspam-2.6.2-3.ppc.rpm">dspam-2.6.2-3.ppc.rpm</a>
  AIX 4.x binary RPM
<li><a href="/aix/dspam-devel-2.6.2-3.ppc.rpm">dspam-devel-2.6.2-3.ppc.rpm</a>
  Development headers and static library
<li><a href="/aix/dspam-python-2.6.2-3.ppc.rpm">dspam-python-2.6.2-3.ppc.rpm</a>
  Python module and utilities
<li> <a href="/linux/rh73/dspam-2.6.2-3.src.rpm">dspam-2.6.2-3</a>RedHat Source RPM
<li> <a href="dspam.patch"> Patches against the original dspam-2.6.2 source</a>
  Fixes bugs and adds python directory.  (Will move python directory
  to separate pydspam project shortly.)
<li> <a href="/linux/dspam-2.6.2.tar.gz">
	dspam-2.6.2 source (dspam site does not have archives)</a>
</menu>

<h3> Check RPMs </h3>
<menu>
<li> <a href="/linux/rh72/check-0.8.4-1.i386.rpm">check-0.8.4 RedHat 7.x RPM</a>
<li> <a href="/aix/check-0.8.4-2.ppc.rpm">check-0.8.4 AIX 4.x RPM</a>
<li> <a href="/aix/check-0.8.4-2.src.rpm">check-0.8.4 source RPM</a>
</menu>

<hr>
<p>
<a href="http://validator.w3.org/check/referer">
<img border=0 src="/vh32.png" alt=" [ Valid HTML 3.2! ] " height=31 width=88></a>
<a href="http://www.redhat.com">
<img src="/art/powered_by.gif" width="88" height="31" alt=" [ Powered By Red Hat Linux ] " border="0"></a>
</p>

</body></html>
